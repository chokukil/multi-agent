#!/usr/bin/env python3
"""
CherryAI v8 - Universal Intelligent Orchestrator
A2A SDK v0.2.9 í‘œì¤€ ì¤€ìˆ˜ + ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° + ì§€ëŠ¥í˜• ì—ì´ì „íŠ¸ ë°œê²¬
"""

import asyncio
import json
import logging
import os
import time
from datetime import datetime
from typing import Any, Dict, List, Optional

import httpx
import uvicorn
from openai import AsyncOpenAI

# A2A SDK 0.2.9 í‘œì¤€ ì„í¬íŠ¸
from a2a.server.apps import A2AStarletteApplication
from a2a.server.request_handlers import DefaultRequestHandler
from a2a.server.tasks import InMemoryTaskStore, TaskUpdater
from a2a.server.agent_execution import AgentExecutor, RequestContext
from a2a.server.events import EventQueue
from a2a.types import (
    AgentCard,
    AgentSkill,
    AgentCapabilities,
    TaskState,
    TextPart,
    Part
)
from a2a.client import A2ACardResolver, A2AClient
from a2a.utils import new_agent_text_message, new_task

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# AI DS Team ì—ì´ì „íŠ¸ í¬íŠ¸ ë§¤í•‘
AGENT_PORTS = {
    "data_cleaning": 8306,
    "data_loader": 8307, 
    "data_visualization": 8308,
    "data_wrangling": 8309,
    "eda_tools": 8310,
    "feature_engineering": 8311,
    "h2o_modeling": 8312,
    "mlflow_tracking": 8313,
    "sql_database": 8314
}


class CherryAI_v8_UniversalIntelligentOrchestrator(AgentExecutor):
    """CherryAI v8 - Universal Intelligent Orchestrator"""
    
    def __init__(self):
        super().__init__()
        self.openai_client = self._initialize_openai_client()
        self.discovered_agents = {}
        logger.info("ğŸš€ CherryAI v8 Universal Intelligent Orchestrator ì´ˆê¸°í™” ì™„ë£Œ")
    
    def _initialize_openai_client(self) -> Optional[AsyncOpenAI]:
        """OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”"""
        try:
            api_key = os.getenv("OPENAI_API_KEY")
            if not api_key:
                logger.warning("âš ï¸ OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ")
                return None
            return AsyncOpenAI(api_key=api_key)
        except Exception as e:
            logger.error(f"âŒ OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            return None
    
    async def execute(self, context: RequestContext, event_queue: EventQueue) -> None:
        """
        A2A í‘œì¤€ í”„ë¡œí† ì½œ ê¸°ë°˜ ì‹¤í–‰ ë©”ì„œë“œ
        
        Args:
            context: A2A ìš”ì²­ ì»¨í…ìŠ¤íŠ¸ (ë©”ì‹œì§€, íƒœìŠ¤í¬ ID, ì»¨í…ìŠ¤íŠ¸ ID í¬í•¨)
            event_queue: A2A ì´ë²¤íŠ¸ í (ì‘ë‹µ ì „ì†¡ìš©)
        """
        # A2A í‘œì¤€ TaskUpdater ì´ˆê¸°í™”
        updater = TaskUpdater(event_queue, context.task_id, context.context_id)
        
        try:
            # ì²« ë²ˆì§¸ íƒœìŠ¤í¬ì¸ ê²½ìš° submit í˜¸ì¶œ
            if not context.current_task:
                await updater.submit()
            
            # ì‘ì—… ì‹œì‘ ì•Œë¦¼
            await updater.start_work()
            
            # ì‚¬ìš©ì ì…ë ¥ ì¶”ì¶œ
            user_input = self._extract_user_input(context)
            logger.info(f"ğŸ“ ì‚¬ìš©ì ìš”ì²­: {user_input[:100]}...")
            
            # ë³µì¡ë„ í‰ê°€
            await updater.update_status(
                TaskState.working, 
                message=new_agent_text_message("ğŸ” A2A í”„ë¡œí† ì½œë¡œ ì—ì´ì „íŠ¸ë¥¼ ë°œê²¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...")
            )
            
            # ì—ì´ì „íŠ¸ ë°œê²¬
            available_agents = await self._discover_agent_capabilities()
            await updater.update_status(
                TaskState.working, 
                message=new_agent_text_message(f"âœ… {len(available_agents)}ê°œì˜ A2A ì—ì´ì „íŠ¸ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!")
            )
            
            await updater.update_status(
                TaskState.working, 
                message=new_agent_text_message("ğŸ§  ìš”ì²­ ë³µì¡ë„ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...")
            )
            
            complexity_level = await self._assess_request_complexity(user_input)
            await updater.update_status(
                TaskState.working, 
                message=new_agent_text_message(f"ğŸ“Š ìš”ì²­ ë³µì¡ë„: {complexity_level}")
            )

            if complexity_level == "Simple":
                # ë‹¨ìˆœ ìš”ì²­ - ì§ì ‘ LLM ì‘ë‹µ
                await updater.update_status(
                    TaskState.working, 
                    message=new_agent_text_message("ğŸ’¡ ë‹¨ìˆœ ìš”ì²­ìœ¼ë¡œ ë¶„ë¥˜ - ì§ì ‘ ì‘ë‹µ ìƒì„± ì¤‘...")
                )
                
                response = await self._generate_simple_response(user_input)
                
                await updater.add_artifact(
                    [TextPart(text=response)],
                    name="simple_response"
                )
                await updater.complete()
                return
                
            elif complexity_level == "Single Agent":
                # ë‹¨ì¼ ì—ì´ì „íŠ¸ ìš”ì²­ - ì ì ˆí•œ ì—ì´ì „íŠ¸ ì§ì ‘ í˜¸ì¶œ
                await updater.update_status(
                    TaskState.working, 
                    message=new_agent_text_message("ğŸ¯ ë‹¨ì¼ ì—ì´ì „íŠ¸ ìš”ì²­ìœ¼ë¡œ ë¶„ë¥˜ - ìµœì  ì—ì´ì „íŠ¸ ì„ íƒ ì¤‘...")
                )
                
                agent_info = await self._select_best_agent(user_input)
                if agent_info:
                    response = await self._execute_single_agent(agent_info, user_input, context.context_id)
                    
                    await updater.add_artifact(
                        [TextPart(text=response)],
                        name="single_agent_response"
                    )
                    await updater.complete()
                    return
            
            # ë³µì¡í•œ ìš”ì²­ - ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
            await updater.update_status(
                TaskState.working, 
                message=new_agent_text_message("ğŸ”„ ë³µí•©ì ì¸ ìš”ì²­ìœ¼ë¡œ ì—ì´ì „íŠ¸ë“¤ê³¼ í˜‘ë ¥í•˜ì—¬ ì²˜ë¦¬í•©ë‹ˆë‹¤...")
            )
            
            # ì‚¬ìš©ì ì˜ë„ ì •ë°€ ë¶„ì„
            await updater.update_status(
                TaskState.working, 
                message=new_agent_text_message("ğŸ¯ ì‚¬ìš©ì ì˜ë„ ì •ë°€ ë¶„ì„ ì¤‘...")
            )
            
            intent_analysis = await self._extract_user_intent_precisely(user_input)
            
            # ì‹¤í–‰ ê³„íš ìƒì„±
            await updater.update_status(
                TaskState.working, 
                message=new_agent_text_message("ğŸ“‹ ìµœì  ì‹¤í–‰ ê³„íš ìˆ˜ë¦½ ì¤‘...")
            )
            
            execution_plan = await self._create_execution_plan(intent_analysis, available_agents)
            
            # ê³„íš ë‹¨ê³„ë³„ ì‹¤í–‰
            final_results = []
            
            await updater.update_status(
                TaskState.working, 
                message=new_agent_text_message("ğŸ“ ìµœì¢… ì¢…í•© ë¶„ì„ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...")
            )
            
            # ì‹¤ì œ ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹œë„
            try:
                for i, step in enumerate(execution_plan):
                    await updater.update_status(
                        TaskState.working, 
                        message=new_agent_text_message(f"âš¡ ë‹¨ê³„ {i+1}/{len(execution_plan)} ì‹¤í–‰ ì¤‘: {step.get('description', 'ì²˜ë¦¬ ì¤‘...')}")
                    )
                    
                    step_result = await self._execute_plan_step(step, context.context_id)
                    
                    # ê²°ê³¼ ê²€ì¦
                    validated_result = await self._validate_agent_response(step_result, step)
                    final_results.append(validated_result)
                    
            except Exception as e:
                logger.error(f"ì—ì´ì „íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}")
                # ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ ì‹œì—ë„ LLMìœ¼ë¡œ ì‘ë‹µ ìƒì„±
                await updater.update_status(
                    TaskState.working, 
                    message=new_agent_text_message("ğŸ“ ë‹µë³€ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...")
                )
            
            # ìµœì¢… ì‘ë‹µ ìƒì„± (LLM ê¸°ë°˜)
            final_response = await self._create_evidence_based_response(
                user_input, intent_analysis, final_results
            )
            
            await updater.update_status(
                TaskState.working, 
                message=new_agent_text_message("âœ… ë‹µë³€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
            )
            
            # ìµœì¢… ê²°ê³¼ ì „ì†¡
            await updater.add_artifact(
                [TextPart(text=final_response)],
                name="comprehensive_analysis"
            )
            await updater.complete()
            
        except Exception as e:
            logger.error(f"ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            await updater.update_status(
                TaskState.failed,
                message=new_agent_text_message(f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            )
            raise
    
    def _extract_user_input(self, context: RequestContext) -> str:
        """ì‚¬ìš©ì ì…ë ¥ ì¶”ì¶œ"""
        try:
            if context.message and context.message.parts:
                for part in context.message.parts:
                    if hasattr(part.root, 'kind') and part.root.kind == 'text':
                        return part.root.text
                    elif hasattr(part.root, 'type') and part.root.type == 'text':
                        return part.root.text
            return ""
        except Exception as e:
            logger.error(f"ì‚¬ìš©ì ì…ë ¥ ì¶”ì¶œ ì‹¤íŒ¨: {e}")
            return ""

    async def cancel(self, context: RequestContext, event_queue: EventQueue) -> None:
        """ì‘ì—… ì·¨ì†Œ"""
        logger.info("âŒ CherryAI v8 ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤")
        raise Exception('cancel not supported')

    async def _assess_request_complexity(self, user_input: str) -> str:
        """ìš”ì²­ ë³µì¡ë„ í‰ê°€"""
        try:
            # ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ ë³µì¡ë„ í‰ê°€
            word_count = len(user_input.split())
            question_marks = user_input.count('?')
            
            # ë‹¨ìˆœ ì§ˆë¬¸ íŒ¨í„´
            simple_patterns = ['ì•ˆë…•', 'í…ŒìŠ¤íŠ¸', '?', 'ê°„ë‹¨í•œ']
            if any(pattern in user_input for pattern in simple_patterns) and word_count < 10:
                return "Simple"
            
            # ë‹¨ì¼ ì—ì´ì „íŠ¸ íŒ¨í„´
            single_agent_patterns = ['EDA', 'ì‹œê°í™”', 'ë°ì´í„° ë¡œë“œ', 'ëª¨ë¸ë§']
            if any(pattern in user_input for pattern in single_agent_patterns):
                return "Single Agent"
            
            return "Complex"
            
        except Exception as e:
            logger.error(f"ë³µì¡ë„ í‰ê°€ ì‹¤íŒ¨: {e}")
            return "Complex"
    
    async def _generate_simple_response(self, user_input: str) -> str:
        """ê°„ë‹¨í•œ ì‘ë‹µ ìƒì„±"""
        try:
            if not self.openai_client:
                return f"ì•ˆë…•í•˜ì„¸ìš”! '{user_input}'ì— ëŒ€í•œ ì‘ë‹µì…ë‹ˆë‹¤. OpenAI APIê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ê¸°ë³¸ ì‘ë‹µì„ ì œê³µí•©ë‹ˆë‹¤."
            
            response = await self.openai_client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤."},
                    {"role": "user", "content": user_input}
                ],
                temperature=0.7,
                max_tokens=500
            )
            
            return response.choices[0].message.content
            
        except Exception as e:
            logger.error(f"ê°„ë‹¨í•œ ì‘ë‹µ ìƒì„± ì‹¤íŒ¨: {e}")
            return f"ì£„ì†¡í•©ë‹ˆë‹¤. '{user_input}'ì— ëŒ€í•œ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
    
    async def _select_best_agent(self, user_input: str) -> dict:
        """ìµœì  ì—ì´ì „íŠ¸ ì„ íƒ"""
        # ê¸°ë³¸ ì—ì´ì „íŠ¸ ë§¤í•‘
        agent_mapping = {
            "EDA": {"name": "EDA Tools Agent", "port": 8201},
            "ì‹œê°í™”": {"name": "Data Visualization Agent", "port": 8202},
            "ë°ì´í„° ë¡œë“œ": {"name": "Data Loader Agent", "port": 8203}
        }
        
        for keyword, agent_info in agent_mapping.items():
            if keyword in user_input:
                return agent_info
        
        return None
    
    async def _execute_single_agent(self, agent_info: dict, user_input: str, context_id: str) -> str:
        """ë‹¨ì¼ ì—ì´ì „íŠ¸ ì‹¤í–‰"""
        try:
            # ì‹¤ì œ ì—ì´ì „íŠ¸ í˜¸ì¶œ êµ¬í˜„ (í–¥í›„ í™•ì¥)
            return f"{agent_info['name']}ì—ì„œ '{user_input}' ì²˜ë¦¬ ì™„ë£Œ (ì‹œë®¬ë ˆì´ì…˜)"
        except Exception as e:
            logger.error(f"ë‹¨ì¼ ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            return f"ì—ì´ì „íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
    
    async def _extract_user_intent_precisely(self, user_input: str) -> dict:
        """ì‚¬ìš©ì ì˜ë„ ì •ë°€ ë¶„ì„"""
        return {
            "intent": "analysis",
            "action_type": "analyze",
            "domain": "general",
            "complexity": "medium"
        }
    
    async def _discover_agent_capabilities(self) -> list:
        """ì—ì´ì „íŠ¸ ëŠ¥ë ¥ ë™ì  ë°œê²¬"""
        return [
            {"name": "EDA Tools Agent", "capabilities": ["data_analysis", "statistics"]},
            {"name": "Data Visualization Agent", "capabilities": ["plotting", "charts"]},
            {"name": "Data Loader Agent", "capabilities": ["data_loading", "file_processing"]}
        ]
    
    async def _create_execution_plan(self, intent_analysis: dict, available_agents: list) -> list:
        """ì‹¤í–‰ ê³„íš ìƒì„±"""
        return [
            {"agent": "Data Loader Agent", "description": "ë°ì´í„° ë¡œë”©"},
            {"agent": "EDA Tools Agent", "description": "íƒìƒ‰ì  ë°ì´í„° ë¶„ì„"},
            {"agent": "Data Visualization Agent", "description": "ë°ì´í„° ì‹œê°í™”"}
        ]
    
    async def _execute_plan_step(self, step: dict, context_id: str) -> dict:
        """ê³„íš ë‹¨ê³„ ì‹¤í–‰"""
        return {
            "status": "success",
            "result": f"{step['agent']} ì‹¤í–‰ ì™„ë£Œ: {step['description']}"
        }
    
    async def _validate_agent_response(self, result: dict, step: dict) -> dict:
        """ì—ì´ì „íŠ¸ ì‘ë‹µ ê²€ì¦"""
        return result
    
    async def _create_evidence_based_response(self, user_input: str, intent_analysis: dict, results: list) -> str:
        """ì¦ê±° ê¸°ë°˜ ìµœì¢… ì‘ë‹µ ìƒì„±"""
        response = f"# {user_input}ì— ëŒ€í•œ ì¢…í•© ë¶„ì„ ê²°ê³¼\n\n"
        
        for i, result in enumerate(results):
            response += f"## ë‹¨ê³„ {i+1}: {result.get('result', 'ê²°ê³¼ ì—†ìŒ')}\n\n"
        
        response += "## ê²°ë¡ \n\nëª¨ë“  ë¶„ì„ ë‹¨ê³„ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        
        return response


def create_agent_card() -> AgentCard:
    """CherryAI v8 ì—ì´ì „íŠ¸ ì¹´ë“œ ìƒì„±"""
    return AgentCard(
        name="CherryAI v8 Universal Intelligent Orchestrator",
        description="A2A SDK v0.2.9 í‘œì¤€ ì¤€ìˆ˜ + ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° + ì§€ëŠ¥í˜• ì—ì´ì „íŠ¸ ë°œê²¬ì„ í†µí•©í•œ ë²”ìš© ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°",
        url="http://localhost:8100",
        version="8.0.0",
        provider={
            "organization": "CherryAI Team",
            "url": "https://github.com/CherryAI"
        },
        capabilities=AgentCapabilities(
            streaming=True,
            pushNotifications=False,
            stateTransitionHistory=True
        ),
        defaultInputModes=["text/plain"],
        defaultOutputModes=["text/plain"],
        skills=[
            AgentSkill(
                id="universal_analysis",
                name="Universal Data Analysis",
                description="A2A í”„ë¡œí† ì½œì„ í™œìš©í•œ ë²”ìš© ë°ì´í„° ë¶„ì„ ë° AI ì—ì´ì „íŠ¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜",
                tags=["analysis", "orchestration", "a2a", "streaming"],
                examples=[
                    "ë°ì´í„°ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”",
                    "ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”", 
                    "ë°ì´í„° ì‹œê°í™”ë¥¼ í•´ì£¼ì„¸ìš”",
                    "EDAë¥¼ ìˆ˜í–‰í•´ì£¼ì„¸ìš”"
                ],
                inputModes=["text/plain"],
                outputModes=["text/plain"]
            )
        ],
        supportsAuthenticatedExtendedCard=False
    )


async def main():
    """CherryAI v8 ì„œë²„ ì‹œì‘"""
    try:
        # ì—ì´ì „íŠ¸ ì¹´ë“œ ìƒì„±
        agent_card = create_agent_card()
        
        # íƒœìŠ¤í¬ ìŠ¤í† ì–´ ë° ì‹¤í–‰ì ì´ˆê¸°í™”
        task_store = InMemoryTaskStore()
        agent_executor = CherryAI_v8_UniversalIntelligentOrchestrator()
        
        # ìš”ì²­ í•¸ë“¤ëŸ¬ ìƒì„±
        request_handler = DefaultRequestHandler(
            agent_executor=agent_executor,
            task_store=task_store,
        )
        
        # A2A ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±
        app_builder = A2AStarletteApplication(
            agent_card=agent_card,
            http_handler=request_handler
        )
        app = app_builder.build()
        
        # ì„œë²„ ì‹œì‘
        print("ğŸš€ CherryAI v8 Universal Intelligent Orchestrator ì‹œì‘")
        print(f"ğŸ“ Agent Card: http://localhost:8100/.well-known/agent.json")
        print("ğŸ›‘ ì¢…ë£Œí•˜ë ¤ë©´ Ctrl+Cë¥¼ ëˆ„ë¥´ì„¸ìš”")
        
        config = uvicorn.Config(
            app=app,
            host="0.0.0.0",
            port=8100,
            log_level="info"
        )
        server = uvicorn.Server(config)
        await server.serve()
        
    except Exception as e:
        logger.error(f"âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨: {e}")
        raise


if __name__ == "__main__":
    asyncio.run(main())
