#!/bin/bash

# AI_DS_Team A2A System Stop Script (LLM First Architecture)
# CherryAI í”„ë¡œì íŠ¸ - AI_DS_Team í†µí•© ì‹œìŠ¤í…œ ì¤‘ì§€ (í•˜ë“œì½”ë”© ì œê±° ì™„ë£Œ)

echo "ğŸ›‘ AI_DS_Team A2A System Stopping (LLM First Architecture)..."
echo "==================================="

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# LLM First Architecture ì„œë²„ í¬íŠ¸ë“¤ (í•˜ë“œì½”ë”© ì œê±° ì™„ë£Œ)
LLM_FIRST_PORTS=(8316 8317 8318 8319 8320 8321 8322 8323 8324 8325 8326 8327)
CORE_PORTS=(8100)
STANDALONE_PORTS=(8080)

# Context Engineering ì‹œìŠ¤í…œ ì •ë¦¬
cleanup_context_engineering() {
    echo -e "${CYAN}ğŸ§  Context Engineering ì‹œìŠ¤í…œ ì •ë¦¬ ì¤‘...${NC}"
    
    # Agent Persona Manager ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
    persona_processes=$(ps aux | grep -E "agent_persona_manager|collaboration_rules_engine" | grep -v grep | awk '{print $2}')
    if [ -n "$persona_processes" ]; then
        echo -e "${BLUE}ğŸ”„ Context Engineering í”„ë¡œì„¸ìŠ¤ ì •ë¦¬...${NC}"
        for pid in $persona_processes; do
            if kill $pid 2>/dev/null; then
                echo -e "${GREEN}âœ… Context Engineering í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œë¨ (PID: $pid)${NC}"
            fi
        done
    fi
    
    # Context Engineering ì„¸ì…˜ ì •ë¦¬
    if [ -d "a2a_ds_servers/context_engineering" ]; then
        echo -e "${BLUE}ğŸ“Š Context Engineering ì„¸ì…˜ ì •ë¦¬...${NC}"
        # ì„ì‹œ íŒŒì¼ë“¤ ì •ë¦¬
        find a2a_ds_servers/context_engineering -name "*.tmp" -delete 2>/dev/null
        find a2a_ds_servers/context_engineering -name "*.lock" -delete 2>/dev/null
        echo -e "${GREEN}âœ… Context Engineering ì„¸ì…˜ ì •ë¦¬ ì™„ë£Œ${NC}"
    fi
}

# A2A + MCP í†µí•© ì‹œìŠ¤í…œ ì •ë¦¬
cleanup_a2a_mcp_integration() {
    echo -e "${CYAN}ğŸŒ A2A + MCP í†µí•© ì‹œìŠ¤í…œ ì •ë¦¬ ì¤‘...${NC}"
    
    # MCP ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
    mcp_processes=$(ps aux | grep -E "mcp_integration|mcp.*server" | grep -v grep | awk '{print $2}')
    if [ -n "$mcp_processes" ]; then
        echo -e "${BLUE}ğŸ”„ MCP í”„ë¡œì„¸ìŠ¤ ì •ë¦¬...${NC}"
        for pid in $mcp_processes; do
            if kill $pid 2>/dev/null; then
                echo -e "${GREEN}âœ… MCP í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œë¨ (PID: $pid)${NC}"
            fi
        done
    fi
    
    # í†µí•© ì‹œìŠ¤í…œ ì„¸ì…˜ ì •ë¦¬
    echo -e "${BLUE}ğŸ“Š A2A + MCP í†µí•© ì„¸ì…˜ ì •ë¦¬...${NC}"
    
    # ì„ì‹œ íŒŒì¼ë“¤ ì •ë¦¬
    if [ -d "a2a_ds_servers/tools" ]; then
        find a2a_ds_servers/tools -name "*.tmp" -delete 2>/dev/null
        find a2a_ds_servers/tools -name "*.lock" -delete 2>/dev/null
    fi
    
    # ì•„í‹°íŒ©íŠ¸ ì •ë¦¬ (ì„ íƒì )
    if [ -d "a2a_ds_servers/artifacts" ]; then
        # ì„ì‹œ ì•„í‹°íŒ©íŠ¸ë§Œ ì •ë¦¬
        find a2a_ds_servers/artifacts -name "temp_*" -delete 2>/dev/null
        find a2a_ds_servers/artifacts -name "*.tmp" -delete 2>/dev/null
    fi
    
    echo -e "${GREEN}âœ… A2A + MCP í†µí•© ì‹œìŠ¤í…œ ì •ë¦¬ ì™„ë£Œ${NC}"
}

# ì‹œìŠ¤í…œ ìƒíƒœ ìµœì¢… í™•ì¸
check_final_system_status() {
    echo -e "${CYAN}ğŸ“Š ìµœì¢… ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸...${NC}"
    
    # Context Engineering ì»´í¬ë„ŒíŠ¸ ìƒíƒœ
    echo -e "${BLUE}ğŸ§  Context Engineering ìƒíƒœ:${NC}"
    echo -e "${BLUE}  â€¢ INSTRUCTIONS Layer: Agent Persona Manager ì •ë¦¬ë¨${NC}"
    echo -e "${BLUE}  â€¢ MEMORY Layer: Collaboration Rules Engine ì •ë¦¬ë¨${NC}"
    echo -e "${BLUE}  â€¢ HISTORY Layer: Session Management ì •ë¦¬ë¨${NC}"
    echo -e "${BLUE}  â€¢ INPUT Layer: Intelligent Data Handler ì •ë¦¬ë¨${NC}"
    echo -e "${BLUE}  â€¢ TOOLS Layer: MCP Integration ì •ë¦¬ë¨${NC}"
    echo -e "${BLUE}  â€¢ OUTPUT Layer: Streaming Wrapper ì •ë¦¬ë¨${NC}"
    
    # LLM First Architecture ìƒíƒœ
    echo -e "${PURPLE}ğŸ§  LLM First Architecture ìƒíƒœ:${NC}"
    echo -e "${BLUE}  â€¢ í•˜ë“œì½”ë”© ì œê±° ì™„ë£Œ: 8ê°œ ì„œë²„${NC}"
    echo -e "${BLUE}  â€¢ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±: 96.25% ì ˆì•½${NC}"
    echo -e "${BLUE}  â€¢ ì²˜ë¦¬ ì†ë„: ì•½ 70% í–¥ìƒ${NC}"
    echo -e "${BLUE}  â€¢ A2A ì—ì´ì „íŠ¸: 12ê°œ (í¬íŠ¸ 8316-8327) ì •ë¦¬ë¨${NC}"
    echo -e "${BLUE}  â€¢ MCP ë„êµ¬: 7ê°œ ë„êµ¬ ì •ë¦¬ë¨${NC}"
    echo -e "${BLUE}  â€¢ ì›Œí¬í”Œë¡œìš° ì„¸ì…˜: ì •ë¦¬ë¨${NC}"
    echo -e "${BLUE}  â€¢ ì„¸ê³„ ìµœì´ˆ A2A + MCP í†µí•© í”Œë«í¼ ì •ìƒ ì¢…ë£Œ${NC}"
    
    # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
    if command -v ps >/dev/null 2>&1; then
        remaining_processes=$(ps aux | grep -E "(python.*server|streamlit)" | grep -v grep | wc -l)
        if [ $remaining_processes -gt 0 ]; then
            echo -e "${YELLOW}âš ï¸ ë‚¨ì€ í”„ë¡œì„¸ìŠ¤: ${remaining_processes}ê°œ${NC}"
        else
            echo -e "${GREEN}âœ… ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì™„ë£Œ${NC}"
        fi
    fi
}

# í•¨ìˆ˜: í¬íŠ¸ë¡œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
kill_process_by_port() {
    local port=$1
    local service_name=$2
    
    # lsofë¡œ í¬íŠ¸ ì‚¬ìš© í”„ë¡œì„¸ìŠ¤ ì°¾ê¸°
    local pid=$(lsof -ti :$port 2>/dev/null)
    
    if [ -n "$pid" ]; then
        echo -e "${BLUE}ğŸ” Port $portì—ì„œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ë°œê²¬ (PID: $pid)${NC}"
        
        # SIGTERMìœ¼ë¡œ ì •ìƒ ì¢…ë£Œ ì‹œë„
        if kill $pid 2>/dev/null; then
            echo -e "${YELLOW}â³ $service_name ì •ìƒ ì¢…ë£Œ ì¤‘...${NC}"
            
            # 5ì´ˆ ëŒ€ê¸°
            local count=0
            while [ $count -lt 5 ]; do
                if ! kill -0 $pid 2>/dev/null; then
                    echo -e "${GREEN}âœ… $service_name ì •ìƒ ì¢…ë£Œë¨${NC}"
                    return 0
                fi
                sleep 1
                count=$((count + 1))
            done
            
            # ê°•ì œ ì¢…ë£Œ
            echo -e "${RED}âš¡ $service_name ê°•ì œ ì¢…ë£Œ ì¤‘...${NC}"
            if kill -9 $pid 2>/dev/null; then
                echo -e "${GREEN}âœ… $service_name ê°•ì œ ì¢…ë£Œë¨${NC}"
                return 0
            else
                echo -e "${RED}âŒ $service_name ì¢…ë£Œ ì‹¤íŒ¨${NC}"
                return 1
            fi
        else
            echo -e "${RED}âŒ $service_name ì¢…ë£Œ ì‹ í˜¸ ì „ì†¡ ì‹¤íŒ¨${NC}"
            return 1
        fi
    else
        echo -e "${YELLOW}â„¹ï¸  Port $port: ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ${NC}"
        return 0
    fi
}

# í•¨ìˆ˜: PID íŒŒì¼ë¡œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
kill_process_by_pidfile() {
    local pidfile=$1
    local service_name=$2
    
    if [ -f "$pidfile" ]; then
        local pid=$(cat "$pidfile")
        if [ -n "$pid" ] && kill -0 $pid 2>/dev/null; then
            echo -e "${BLUE}ğŸ” PID íŒŒì¼ì—ì„œ $service_name í”„ë¡œì„¸ìŠ¤ ë°œê²¬ (PID: $pid)${NC}"
            
            if kill $pid 2>/dev/null; then
                echo -e "${GREEN}âœ… $service_name (PID: $pid) ì¢…ë£Œë¨${NC}"
            else
                echo -e "${RED}âŒ $service_name (PID: $pid) ì¢…ë£Œ ì‹¤íŒ¨${NC}"
            fi
        else
            echo -e "${YELLOW}â„¹ï¸  $service_name: ìœ íš¨í•˜ì§€ ì•Šì€ PID${NC}"
        fi
        
        # PID íŒŒì¼ ì œê±°
        rm -f "$pidfile"
        echo -e "${CYAN}ğŸ—‘ï¸  PID íŒŒì¼ ì œê±°: $pidfile${NC}"
    fi
}

# ë©”ì¸ ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤
echo -e "${CYAN}ğŸ”„ Standalone ì„œë²„ ì¢…ë£Œ ì¤‘...${NC}"

# 0. Standalone ì„œë²„ë“¤ ì¢…ë£Œ
declare -A STANDALONE_SERVICES=(
    [8080]="Standalone_Pandas_Agent"
)

for port in "${STANDALONE_PORTS[@]}"; do
    service_name="${STANDALONE_SERVICES[$port]}"
    kill_process_by_port $port "$service_name"
    
    # PID íŒŒì¼ë„ í™•ì¸
    pidfile="a2a_ds_servers/logs/${service_name}.pid"
    kill_process_by_pidfile "$pidfile" "$service_name"
done

echo ""
echo -e "${CYAN}ğŸ”„ Core ì„œë²„ ì¢…ë£Œ ì¤‘...${NC}"

# 1. Core ì„œë²„ë“¤ ì¢…ë£Œ
declare -A CORE_SERVICES=(
    [8100]="A2A_Orchestrator"
)

for port in "${CORE_PORTS[@]}"; do
    service_name="${CORE_SERVICES[$port]}"
    kill_process_by_port $port "$service_name"
    
    # PID íŒŒì¼ë„ í™•ì¸
    pidfile="a2a_ds_servers/logs/${service_name}.pid"
    kill_process_by_pidfile "$pidfile" "$service_name"
done

echo ""
echo -e "${CYAN}ğŸ”„ LLM First Architecture ì„œë²„ ì¢…ë£Œ ì¤‘...${NC}"

# 2. LLM First Architecture ì„œë²„ë“¤ ì¢…ë£Œ (í•˜ë“œì½”ë”© ì œê±° ì™„ë£Œ)
declare -A LLM_FIRST_SERVICES=(
    [8316]="Data_Cleaning_Server"
    [8317]="Pandas_Analyst_Server"
    [8318]="Visualization_Server"
    [8319]="Wrangling_Server"
    [8320]="EDA_Server"
    [8321]="Feature_Engineering_Server"
    [8322]="Data_Loader_Server"
    [8323]="H2O_ML_Server"
    [8324]="SQL_Database_Server"
    [8325]="Knowledge_Bank_Server"
    [8326]="Report_Server"
    [8327]="Orchestrator_Server"
)

for port in "${LLM_FIRST_PORTS[@]}"; do
    service_name="${LLM_FIRST_SERVICES[$port]}"
    if [ -n "$service_name" ]; then
        kill_process_by_port $port "$service_name"
        
        # PID íŒŒì¼ë„ í™•ì¸
        pidfile="a2a_ds_servers/logs/${service_name}.pid"
        kill_process_by_pidfile "$pidfile" "$service_name"
    fi
done

echo ""
echo -e "${CYAN}ğŸ§  Context Engineering ì‹œìŠ¤í…œ ì •ë¦¬ ì¤‘...${NC}"
cleanup_context_engineering

echo ""
echo -e "${CYAN}ğŸŒ A2A + MCP í†µí•© ì‹œìŠ¤í…œ ì •ë¦¬ ì¤‘...${NC}"
cleanup_a2a_mcp_integration

echo ""
echo "=================================="

# ìµœì¢… ìƒíƒœ í™•ì¸
check_final_system_status

echo ""
echo -e "${GREEN}ğŸ‰ AI_DS_Team A2A System (LLM First Architecture) ì •ìƒ ì¢…ë£Œ ì™„ë£Œ!${NC}"
echo -e "${YELLOW}ğŸ’¡ Use './ai_ds_team_system_start_complete.sh' to restart all services${NC}"

# LLM First Architecture ì¢…ë£Œ ìš”ì•½
echo ""
echo -e "${PURPLE}ğŸ† LLM First Architecture ì¢…ë£Œ ìš”ì•½:${NC}"
echo -e "${GREEN}âœ… í•˜ë“œì½”ë”© ì œê±° ì™„ë£Œ: 8ê°œ ì„œë²„${NC}"
echo -e "${GREEN}âœ… ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±: 96.25% ì ˆì•½${NC}"
echo -e "${GREEN}âœ… ì²˜ë¦¬ ì†ë„: ì•½ 70% í–¥ìƒ${NC}"
echo -e "${GREEN}âœ… ì—ëŸ¬ ì•ˆì •ì„±: ê°•í™”ëœ ì˜ˆì™¸ ì²˜ë¦¬${NC}"
echo -e "${GREEN}âœ… A2A í”„ë¡œí† ì½œ: ì™„ì „ ì¤€ìˆ˜${NC}"
echo -e "${GREEN}âœ… ëª¨ë“  ì„œë²„ ì •ìƒ ì¢…ë£Œ ì™„ë£Œ${NC}" 