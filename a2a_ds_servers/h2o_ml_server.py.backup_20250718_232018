#!/usr/bin/env python3
"""
AI_DS_Team H2OMLAgent A2A Server - ì›ë³¸ 100% LLM First íŒ¨í„´
Port: 8323

ì›ë³¸ ai-data-science-teamì˜ H2OMLAgentë¥¼ 100% ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ì„œ
ì„±ê³µí•œ A2A ì—ì´ì „íŠ¸ë“¤ì˜ ë°ì´í„° ì²˜ë¦¬ íŒ¨í„´ì„ ì ìš©í•œ ì™„ì „í•œ LLM First êµ¬í˜„
"""

import asyncio
import sys
import os
from pathlib import Path
import json
import logging
import pandas as pd
import numpy as np
import io

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì¶”ê°€
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))
sys.path.insert(0, str(project_root / "ai_ds_team"))

# A2A imports
from a2a.server.apps import A2AStarletteApplication
from a2a.server.request_handlers.default_request_handler import DefaultRequestHandler
from a2a.server.tasks.inmemory_task_store import InMemoryTaskStore
from a2a.server.tasks.task_updater import TaskUpdater
from a2a.server.agent_execution import AgentExecutor, RequestContext
from a2a.server.events.event_queue import EventQueue
from a2a.types import TextPart, TaskState, AgentCard, AgentSkill, AgentCapabilities
from a2a.utils import new_agent_text_message
import uvicorn

# ì›ë³¸ AI_DS_Team imports - 100% ì›ë³¸ íŒ¨í„´
from ai_data_science_team.ml_agents import H2OMLAgent
from ai_data_science_team.tools.dataframe import get_dataframe_summary

# Core imports - ì„±ê³µí•œ ì—ì´ì „íŠ¸ íŒ¨í„´
from core.data_manager import DataManager
from core.llm_factory import create_llm_instance
from dotenv import load_dotenv

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()


class PandasAIDataProcessor:
    """pandas-ai íŒ¨í„´ì„ í™œìš©í•œ ë°ì´í„° ì²˜ë¦¬ê¸° (ì„±ê³µí•œ íŒ¨í„´)"""
    
    def __init__(self):
        self.current_dataframe = None
        
    def parse_data_from_message(self, user_message: str) -> pd.DataFrame:
        """ì‚¬ìš©ì ë©”ì‹œì§€ì—ì„œ ë°ì´í„°ë¥¼ íŒŒì‹± - ìƒ˜í”Œ ë°ì´í„° ìƒì„± ê¸ˆì§€"""
        logger.info("ğŸ“Š pandas-ai íŒ¨í„´ìœ¼ë¡œ ë©”ì‹œì§€ì—ì„œ ë°ì´í„° íŒŒì‹±...")
        
        # 1. CSV ë°ì´í„° íŒŒì‹±
        lines = user_message.split('\n')
        csv_lines = [line.strip() for line in lines if ',' in line and len(line.split(',')) >= 2]
        
        if len(csv_lines) >= 2:  # í—¤ë” + ë°ì´í„°
            try:
                csv_content = '\n'.join(csv_lines)
                df = pd.read_csv(io.StringIO(csv_content))
                logger.info(f"âœ… CSV ë°ì´í„° íŒŒì‹± ì„±ê³µ: {df.shape}")
                return df
            except Exception as e:
                logger.warning(f"CSV íŒŒì‹± ì‹¤íŒ¨: {e}")
        
        # 2. JSON ë°ì´í„° íŒŒì‹±
        try:
            json_start = user_message.find('{')
            json_end = user_message.rfind('}') + 1
            
            if json_start != -1 and json_end > json_start:
                json_content = user_message[json_start:json_end]
                data = json.loads(json_content)
                
                if isinstance(data, list):
                    df = pd.DataFrame(data)
                    logger.info(f"âœ… JSON ë¦¬ìŠ¤íŠ¸ ë°ì´í„° íŒŒì‹± ì„±ê³µ: {df.shape}")
                    return df
                elif isinstance(data, dict):
                    df = pd.DataFrame([data])
                    logger.info(f"âœ… JSON ê°ì²´ ë°ì´í„° íŒŒì‹± ì„±ê³µ: {df.shape}")
                    return df
        except json.JSONDecodeError as e:
            logger.warning(f"JSON íŒŒì‹± ì‹¤íŒ¨: {e}")
        
        # 3. ë°ì´í„° ì—†ìŒ - None ë°˜í™˜ (ìƒ˜í”Œ ë°ì´í„° ìƒì„± ê¸ˆì§€)
        logger.info("âŒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        return None
    
    def validate_and_process_data(self, df: pd.DataFrame) -> bool:
        """ë°ì´í„° ìœ íš¨ì„± ê²€ì¦"""
        if df is None or df.empty:
            return False
        
        logger.info(f"ğŸ“Š ë°ì´í„° ê²€ì¦: {df.shape} (í–‰ x ì—´)")
        logger.info(f"ğŸ” ì»¬ëŸ¼: {list(df.columns)}")
        logger.info(f"ğŸ“ˆ íƒ€ì…: {df.dtypes.to_dict()}")
        
        return True


class H2OMLAgent:
    """H2OMLAgentë¥¼ ì‚¬ìš©í•œ ë˜í¼ í´ë˜ìŠ¤ - ì„±ê³µí•œ loader_server.py íŒ¨í„´ ì ìš©"""
    
    def __init__(self):
        # ğŸ”¥ ì„±ê³µí•œ íŒ¨í„´ 1: Data Manager ì´ˆê¸°í™” (í•„ìˆ˜)
        try:
            from core.data_manager import DataManager
            self.data_manager = DataManager()
            logger.info("âœ… Data Manager initialized")
        except Exception as e:
            logger.error(f"âŒ Failed to initialize Data Manager: {e}")
            raise RuntimeError("Data Manager is required for operation") from e
        
        # ğŸ”¥ ì„±ê³µí•œ íŒ¨í„´ 2: Real LLM ì´ˆê¸°í™” (í•„ìˆ˜, í´ë°± ì—†ìŒ)
        self.llm = None
        self.agent = None
        
        try:
            api_key = os.getenv('OPENAI_API_KEY') or os.getenv('ANTHROPIC_API_KEY') or os.getenv('GOOGLE_API_KEY')
            if not api_key:
                raise ValueError("No LLM API key found in environment variables")
                
            from core.llm_factory import create_llm_instance
            # ğŸ”¥ ì„±ê³µí•œ íŒ¨í„´ ë³´ì¡´: ai_data_science_team ì—ì´ì „íŠ¸ë“¤ ì‚¬ìš©
            sys.path.append(os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'ai_ds_team'))
            from ai_data_science_team.ml_agents import H2OMLAgent as OriginalAgent
            
            self.llm = create_llm_instance()
            
            # ğŸ”¥ ì„±ê³µí•œ íŒ¨í„´ 3: H2OMLAgent ì´ˆê¸°í™” (ì •í™•í•œ íŒ¨í„´ ë³´ì¡´)
            self.agent = OriginalAgent(
                model=self.llm,
                log=True,
                log_path="logs/h2o/",
                model_directory="models/h2o/",
                overwrite=True
            )
            logger.info("âœ… Real LLM initialized for H2O ML Agent")
        except Exception as e:
            logger.error(f"âŒ Failed to initialize LLM: {e}")
            raise RuntimeError("LLM initialization is required for operation") from e
    
    async def invoke(self, user_instructions: str) -> dict:
        """H2O ML Agent ì‹¤í–‰ - ì„±ê³µí•œ íŒ¨í„´ ì ìš©"""
        logger.info("ğŸš€ H2O ML Agent invoke ì‹œì‘")
        
        # ë°ì´í„° íŒŒì‹± (ì„±ê³µí•œ íŒ¨í„´)
        data_processor = PandasAIDataProcessor()
        df = data_processor.parse_data_from_message(user_instructions)
        
        if df is None:
            # ë°ì´í„° ì—†ì´ H2O ê°€ì´ë“œ ì œê³µ
            return {
                'user_instructions': user_instructions,
                'h2o_result': self._generate_h2o_guidance(user_instructions),
                'dataframe': pd.DataFrame(),
            }
        
        # íƒ€ê²Ÿ ë³€ìˆ˜ ê°ì§€
        target_variable = self._detect_target_variable(df, user_instructions)
        
        # ğŸ”¥ ì›ë³¸ H2OMLAgent invoke_agent í˜¸ì¶œ
        logger.info(f"ğŸ¯ íƒ€ê²Ÿ ë³€ìˆ˜: {target_variable}")
        logger.info("ğŸ¤– ì›ë³¸ H2OMLAgent.invoke_agent ì‹¤í–‰ ì¤‘...")
        
        self.agent.invoke_agent(
            data_raw=df,
            user_instructions=user_instructions,
            target_variable=target_variable
        )
        
        # ê²°ê³¼ ì¶”ì¶œ
        h2o_function = self.agent.get_h2o_train_function()
        workflow_summary = self.agent.get_workflow_summary()
        recommended_steps = self.agent.get_recommended_ml_steps()
        leaderboard = self.agent.get_leaderboard()
        best_model_id = self.agent.get_best_model_id()
        model_path = self.agent.get_model_path()
            
            # ê²°ê³¼ êµ¬ì„±
            h2o_result = f"""# ğŸ¤– **H2O AutoML Complete!**

## ğŸ“Š **ì²˜ë¦¬ëœ ë°ì´í„°**
- **ë°ì´í„° í¬ê¸°**: {df.shape[0]}í–‰ Ã— {df.shape[1]}ì—´
- **ì»¬ëŸ¼**: {', '.join(df.columns.tolist())}
- **íƒ€ê²Ÿ ë³€ìˆ˜**: {target_variable}

## ğŸ¯ **H2O AutoML ì²˜ë¦¬ ê²°ê³¼**

### ğŸ”„ ì›Œí¬í”Œë¡œìš° ìš”ì•½
{workflow_summary if workflow_summary else "H2O AutoMLì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤."}

### ğŸ“‹ ì¶”ì²œ ML ë‹¨ê³„
{recommended_steps if recommended_steps else "í‘œì¤€ H2O AutoML í”„ë¡œì„¸ìŠ¤ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."}

### ğŸ† **ëª¨ë¸ ê²°ê³¼**
- **ìµœê³  ëª¨ë¸ ID**: {best_model_id if best_model_id else "N/A"}
- **ëª¨ë¸ ì €ì¥ ê²½ë¡œ**: {model_path if model_path else "N/A"}
- **ë¦¬ë”ë³´ë“œ**: {"ì‚¬ìš© ê°€ëŠ¥" if leaderboard is not None else "N/A"}

### ğŸ’» **ìƒì„±ëœ H2O í•¨ìˆ˜**
```python
{h2o_function if h2o_function else "# H2O AutoML í•¨ìˆ˜ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."}
```

## ğŸ“ˆ **ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°**
```
{df.head().to_string()}
```

âœ… **ì›ë³¸ ai-data-science-team H2OMLAgentê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**
"""
            
            logger.info("âœ… ì›ë³¸ H2OMLAgent ì‹¤í–‰ ì™„ë£Œ")
            
            return {
                'user_instructions': user_instructions,
                'h2o_result': h2o_result,
                'dataframe': df,
                'h2o_function': h2o_function,
                'workflow_summary': workflow_summary,
                'recommended_steps': recommended_steps,
                'leaderboard': leaderboard,
                'best_model_id': best_model_id,
                'model_path': model_path
            }
            
        except Exception as e:
            logger.error(f"âŒ H2OMLAgent ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            return {
                'error': str(e),
                'user_instructions': user_instructions,
                'h2o_result': f"âŒ H2O AutoML ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}",
                'dataframe': df if df is not None else pd.DataFrame()
            }
    
    def _detect_target_variable(self, df: pd.DataFrame, user_instructions: str) -> str:
        """íƒ€ê²Ÿ ë³€ìˆ˜ ìë™ ê°ì§€"""
        # ì‚¬ìš©ì ì§€ì‹œì‚¬í•­ì—ì„œ íƒ€ê²Ÿ ë³€ìˆ˜ ì¶”ì¶œ ì‹œë„
        for col in df.columns:
            if col.lower() in user_instructions.lower():
                logger.info(f"ğŸ¯ íƒ€ê²Ÿ ë³€ìˆ˜ ê°ì§€: {col}")
                return col
        
        # ì¼ë°˜ì ì¸ íƒ€ê²Ÿ ë³€ìˆ˜ëª…ë“¤
        common_targets = ['target', 'label', 'class', 'y', 'outcome', 'result']
        for target in common_targets:
            if target in df.columns:
                logger.info(f"ğŸ¯ ì¼ë°˜ì  íƒ€ê²Ÿ ë³€ìˆ˜ ê°ì§€: {target}")
                return target
        
        # ë§ˆì§€ë§‰ ì»¬ëŸ¼ì„ íƒ€ê²Ÿìœ¼ë¡œ ê°€ì •
        target = df.columns[-1]
        logger.info(f"ğŸ¯ ë§ˆì§€ë§‰ ì»¬ëŸ¼ì„ íƒ€ê²Ÿìœ¼ë¡œ ì„¤ì •: {target}")
        return target
    
    def _generate_h2o_guidance(self, user_instructions: str) -> str:
        """ë°ì´í„° ì—†ì´ H2O AutoML ê°€ì´ë“œ ì œê³µ"""
        return f"""# ğŸ¤– **H2O AutoML ê°€ì´ë“œ**

## ğŸ“ **ìš”ì²­ ë‚´ìš©**
{user_instructions}

## ğŸ¯ **H2O AutoML ì™„ì „ ê°€ì´ë“œ**

### 1. **H2O AutoML ì„¤ì¹˜ ë° ì´ˆê¸°í™”**
```python
# H2O ì„¤ì¹˜
pip install h2o

# H2O ì´ˆê¸°í™”
import h2o
h2o.init()
```

### 2. **ê¸°ë³¸ ë¶„ë¥˜ ëª¨ë¸**
```python
from h2o.automl import H2OAutoML

# ë°ì´í„° ë¡œë“œ
train = h2o.import_file("train.csv")
test = h2o.import_file("test.csv")

# íŠ¹ì„±ê³¼ íƒ€ê²Ÿ ì •ì˜
x = train.columns
y = "target_column"
x.remove(y)

# AutoML ì‹¤í–‰
aml = H2OAutoML(max_models=20, seed=1, max_runtime_secs=300)
aml.train(x=x, y=y, training_frame=train)

# ë¦¬ë”ë³´ë“œ í™•ì¸
print(aml.leaderboard.head())
```

### 3. **íšŒê·€ ëª¨ë¸**
```python
# íšŒê·€ ë¬¸ì œì˜ ê²½ìš°
aml = H2OAutoML(
    max_models=10, 
    max_runtime_secs=600, 
    seed=1,
    sort_metric="rmse"  # íšŒê·€ìš© ì§€í‘œ
)
aml.train(x=x, y=y, training_frame=train)

# ìµœê³  ëª¨ë¸ ì„±ëŠ¥ í™•ì¸
best_model = aml.leader
perf = best_model.model_performance(test)
print(f"RMSE: {perf.rmse()}")
```

### 4. **ëª¨ë¸ í•´ì„ ë° ì‹œê°í™”**
```python
# ë³€ìˆ˜ ì¤‘ìš”ë„
best_model.varimp_plot()

# SHAP ê°’ (Shapley values)
best_model.shap_summary_plot(train)

# ë¶€ë¶„ ì˜ì¡´ì„± í”Œë¡¯
best_model.pd_plot(train, column="feature_name")

# ëª¨ë¸ ì„±ëŠ¥ ì‹œê°í™”
perf.plot()
```

## ğŸ’¡ **ë°ì´í„°ë¥¼ í¬í•¨í•´ì„œ ë‹¤ì‹œ ìš”ì²­í•˜ë©´ ì‹¤ì œ H2O AutoML ëª¨ë¸ë§ì„ ìˆ˜í–‰í•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!**

**ë°ì´í„° í˜•ì‹ ì˜ˆì‹œ**:
- **CSV**: `feature1,feature2,target\\n1.0,2.0,1\\n1.5,2.5,0`
- **JSON**: `[{"feature1": 1.0, "feature2": 2.0, "target": 1}]`

### ğŸ”— **ì¶”ê°€ ë¦¬ì†ŒìŠ¤**
- H2O ê³µì‹ ë¬¸ì„œ: https://docs.h2o.ai/
- H2O AutoML ê°€ì´ë“œ: https://docs.h2o.ai/h2o/latest-stable/h2o-docs/automl.html
- H2O íŠœí† ë¦¬ì–¼: https://github.com/h2oai/h2o-tutorials
"""
    
    def generate_response(self, h2o_result: dict, user_instructions: str) -> str:
        """ìµœì¢… ì‘ë‹µ ìƒì„± (ì„±ê³µí•œ ì—ì´ì „íŠ¸ íŒ¨í„´)"""
        result = h2o_result.get('h2o_result', '')
        
        # ë°ì´í„° ì €ì¥ ì •ë³´ ì¶”ê°€
        if 'dataframe' in h2o_result and not h2o_result['dataframe'].empty:
            df = h2o_result['dataframe']
            result += f"""

### ğŸ“ **ë°ì´í„° ì €ì¥ ì •ë³´**
- **ì²˜ë¦¬ëœ ë°ì´í„° í¬ê¸°**: {df.shape[0]}í–‰ Ã— {df.shape[1]}ì—´
- **ì €ì¥ ìœ„ì¹˜**: a2a_ds_servers/artifacts/data/shared_dataframes/
- **ì‚¬ìš© ê°€ëŠ¥í•œ ì»¬ëŸ¼**: {', '.join(df.columns.tolist())}

### ğŸ” **ë°ì´í„° ìš”ì•½**
```
{df.describe().to_string()}
```
"""
        
        return result


class H2OMLAgentExecutor(AgentExecutor):
    """H2O ML Agent A2A Executor - ì„±ê³µí•œ loader_server.py íŒ¨í„´ ì ìš©"""
    
    def __init__(self):
        self.agent = H2OMLAgent()
        logger.info("ğŸ¤– H2O ML Agent Executor ì´ˆê¸°í™” ì™„ë£Œ")
    
    async def execute(self, context: RequestContext, event_queue: EventQueue) -> None:
        """ì„±ê³µí•œ A2A íŒ¨í„´ìœ¼ë¡œ H2O ML Agent ì‹¤í–‰"""
        logger.info(f"ğŸš€ H2O ML Agent ì‹¤í–‰ ì‹œì‘ - Task: {context.task_id}")
        
        # TaskUpdater ì´ˆê¸°í™” (ì„±ê³µí•œ íŒ¨í„´)
        task_updater = TaskUpdater(event_queue, context.task_id, context.context_id)
        
        try:
            await task_updater.submit()
            await task_updater.start_work()
            
            await task_updater.update_status(
                TaskState.working,
                message=new_agent_text_message("ğŸ¤– ì›ë³¸ ai-data-science-team H2OMLAgent ì‹œì‘...")
            )
            
            # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ì¶œ (ì„±ê³µí•œ íŒ¨í„´)
            user_instructions = ""
            for part in context.message.parts:
                if hasattr(part.root, 'text'):
                    user_instructions += part.root.text + " "
            
            user_instructions = user_instructions.strip()
            logger.info(f"ğŸ“ ì‚¬ìš©ì ìš”ì²­: {user_instructions[:100]}...")
            
            # H2O ML Agent ì‹¤í–‰
            result = await self.agent.invoke(user_instructions)
            
            # A2A ì‘ë‹µ ì „ì†¡ (ì„±ê³µí•œ íŒ¨í„´)
            await task_updater.update_status(
                TaskState.completed,
                message=new_agent_text_message(result['h2o_result'])
            )
            
            logger.info("âœ… H2O ML Agent ì‹¤í–‰ ì™„ë£Œ")
                
        except Exception as e:
            logger.error(f"âŒ H2O ML Agent ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            await task_updater.update_status(
                TaskState.completed,
                message=new_agent_text_message(f"âŒ H2O ML ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            )
    
    async def cancel(self, context: RequestContext, event_queue: EventQueue) -> None:
        """ì‘ì—… ì·¨ì†Œ (ì„±ê³µí•œ ì—ì´ì „íŠ¸ íŒ¨í„´)"""
        task_updater = TaskUpdater(event_queue, context.task_id, context.context_id)
        await task_updater.reject()


def main():
    """ì„œë²„ ìƒì„± ë° ì‹¤í–‰"""
    
    # AgentSkill ì •ì˜
    skill = AgentSkill(
        id="h2o_automl",
        name="H2O AutoML Modeling", 
        description="ì›ë³¸ ai-data-science-team H2OMLAgentë¥¼ í™œìš©í•œ ì™„ì „í•œ AutoML ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.",
        tags=["h2o", "automl", "machine-learning", "modeling", "prediction", "ai-data-science-team"],
        examples=[
            "H2O AutoMLë¡œ ë¶„ë¥˜ ëª¨ë¸ì„ êµ¬ì¶•í•´ì£¼ì„¸ìš”",
            "íšŒê·€ ë¶„ì„ ëª¨ë¸ì„ ìë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”", 
            "ìµœì ì˜ ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ ì°¾ì•„ì£¼ì„¸ìš”",
            "H2Oë¥¼ ì‚¬ìš©í•´ì„œ ëª¨ë¸ ì„±ëŠ¥ì„ ë¹„êµí•´ì£¼ì„¸ìš”",
            "AutoMLë¡œ ì˜ˆì¸¡ ëª¨ë¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
        ]
    )
    
    # Agent Card ì •ì˜
    agent_card = AgentCard(
        name="H2O ML Agent",
        description="ì›ë³¸ ai-data-science-team H2OMLAgentë¥¼ í™œìš©í•œ ì™„ì „í•œ AutoML ì„œë¹„ìŠ¤",
        url="http://localhost:8323/",
        version="1.0.0",
        defaultInputModes=["text"],
        defaultOutputModes=["text"],
        capabilities=AgentCapabilities(streaming=True),
        skills=[skill],
        supportsAuthenticatedExtendedCard=False
    )
    
    # Request Handler ìƒì„±
    request_handler = DefaultRequestHandler(
        agent_executor=H2OMLAgentExecutor(),
        task_store=InMemoryTaskStore(),
    )
    
    # A2A Server ìƒì„±
    server = A2AStarletteApplication(
        agent_card=agent_card,
        http_handler=request_handler,
    )
    
    print("ğŸ¤– Starting H2O ML Agent Server")
    print("ğŸŒ Server starting on http://localhost:8323")
    print("ğŸ“‹ Agent card: http://localhost:8323/.well-known/agent.json")
    print("ğŸ¯ Features: ì›ë³¸ ai-data-science-team H2OMLAgent 100% + ì„±ê³µí•œ A2A íŒ¨í„´")
    
    uvicorn.run(server.build(), host="0.0.0.0", port=8323, log_level="info")


if __name__ == "__main__":
    main() 