#!/usr/bin/env python3
"""
Data Wrangling Server - A2A Compatible 
ğŸ¯ ì›ë˜ ê¸°ëŠ¥ 100% ìœ ì§€í•˜ë©´ì„œ A2A í”„ë¡œí† ì½œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ 
í¬íŠ¸: 8319 (Enhanced)
"""

import logging
import uvicorn
import os
import sys
import json
import pandas as pd
from dotenv import load_dotenv

# Add parent directory to path for core modules
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Load environment variables
load_dotenv()

# A2A SDK imports - 0.2.9 í‘œì¤€ íŒ¨í„´
from a2a.server.apps import A2AStarletteApplication
from a2a.server.agent_execution import AgentExecutor, RequestContext
from a2a.server.request_handlers import DefaultRequestHandler
from a2a.server.tasks import InMemoryTaskStore
from a2a.server.events import EventQueue
from a2a.server.tasks.task_updater import TaskUpdater
from a2a.types import AgentCard, AgentSkill, AgentCapabilities, TaskState, TextPart
from a2a.utils import new_agent_text_message

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class WranglingAgentWrapper:
    """Data Wrangling Agent Wrapper with LLM integration - ì›ë˜ ê¸°ëŠ¥ 100% ë³´ì¡´."""

    def __init__(self):
        # ğŸ”¥ ì›ë˜ ê¸°ëŠ¥ 1: Data Manager ì´ˆê¸°í™” (í•„ìˆ˜)
        try:
            from core.data_manager import DataManager
            self.data_manager = DataManager()
            logger.info("âœ… Data Manager initialized")
        except Exception as e:
            logger.error(f"âŒ Failed to initialize Data Manager: {e}")
            raise RuntimeError("Data Manager is required for operation") from e
        
        # ğŸ”¥ ì›ë˜ ê¸°ëŠ¥ 2: Real LLM ì´ˆê¸°í™” (í•„ìˆ˜, í´ë°± ì—†ìŒ)
        self.llm = None
        self.agent = None
        
        try:
            api_key = os.getenv('OPENAI_API_KEY') or os.getenv('ANTHROPIC_API_KEY') or os.getenv('GOOGLE_API_KEY')
            if not api_key:
                raise ValueError("No LLM API key found in environment variables")
                
            from core.llm_factory import create_llm_instance
            # ğŸ”¥ ì›ë˜ ê¸°ëŠ¥ ë³´ì¡´: ai_data_science_team ì—ì´ì „íŠ¸ë“¤ ì‚¬ìš©
            sys.path.append(os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'ai_ds_team'))
            from ai_data_science_team.agents import DataWranglingAgent as DSTeamWranglingAgent
            
            self.llm = create_llm_instance()
            
            # ğŸ”¥ ì›ë˜ ê¸°ëŠ¥ 3: Data Wrangling Agent ì´ˆê¸°í™” (ì •í™•í•œ íŒ¨í„´ ë³´ì¡´)
            self.data_wrangling_agent = DSTeamWranglingAgent(model=self.llm)
            
            # ğŸ”¥ ì›ë˜ ê¸°ëŠ¥ 4: í†µí•© ì‘ë‹µ ì‹œìŠ¤í…œ (ì›ë˜ ê¸°ëŠ¥ 100% ë³´ì¡´)
            self.response = None
            self._data_wrangled = None
            self._wrangler_function = None
            
            logger.info("âœ… Real LLM initialized for Data Wrangling Agent")
        except Exception as e:
            logger.error(f"âŒ Failed to initialize LLM: {e}")
            raise RuntimeError("Real LLM is required for operation") from e

    def _generate_sample_data(self, user_instructions: str):
        """ğŸ”¥ ì›ë˜ ê¸°ëŠ¥: ìƒ˜í”Œ ë°ì´í„° ìƒì„± (ì‹œì—°ìš©)"""
        import numpy as np
        
        sample_data = pd.DataFrame({
            'id': range(1, 101),
            'category': np.random.choice(['A', 'B', 'C'], 100),
            'value': np.random.randn(100) * 10 + 50,
            'score': np.random.randint(1, 100, 100),
            'date': pd.date_range('2023-01-01', periods=100, freq='D'),
            'status': np.random.choice(['active', 'inactive'], 100)
        })
        
        logger.info(f"ğŸ“Š Generated sample data: {sample_data.shape} for wrangling demonstration")
        return sample_data

    def process_data_wrangling(self, user_instructions: str, uploaded_data=None):
        """ğŸ”¥ ì›ë˜ ê¸°ëŠ¥: ë°ì´í„° ë˜ê¸€ë§ ì²˜ë¦¬ ë¡œì§ 100% êµ¬í˜„"""
        try:
            # Step 1: ë°ì´í„° í™•ë³´
            if uploaded_data is not None:
                data_raw = uploaded_data
                logger.info(f"ğŸ“ Using uploaded data: {type(data_raw)}")
            else:
                data_raw = self._generate_sample_data(user_instructions)
                logger.info("ğŸ² Using generated sample data for demonstration")
            
            # Step 2: AI_DS_Team DataWranglingAgent ì‹¤í–‰
            logger.info("ğŸ”§ Performing data wrangling with AI agent...")
            
            # ì›ë˜ ê¸°ëŠ¥ ë³´ì¡´: invoke_agent ë©”ì„œë“œ ì‚¬ìš©
            result = self.data_wrangling_agent.invoke_agent(
                user_instructions=user_instructions,
                data_raw=data_raw.to_dict() if hasattr(data_raw, 'to_dict') else data_raw,
                max_retries=3,
                retry_count=0
            )
            
            # Step 3: ê²°ê³¼ ì¶”ì¶œ
            self._data_wrangled = self.data_wrangling_agent.get_data_wrangled()
            self._wrangler_function = self.data_wrangling_agent.get_data_wrangler_function()
            
            # Step 4: ì‘ë‹µ ìƒì„± (ì›ë˜ íŒ¨í„´ ë³´ì¡´)
            self.response = {
                "messages": [{
                    "content": f"âœ… **Data Wrangling Complete!**\n\n**Query:** {user_instructions}\n\n**Wrangling:** Data transformation completed successfully with AI agent."
                }],
                "data_wrangled": self._data_wrangled,
                "wrangler_function": self._wrangler_function
            }
            
            logger.info("âœ… Data wrangling processing completed successfully")
            return self.response
            
        except Exception as e:
            logger.error(f"âŒ Error in data wrangling: {e}", exc_info=True)
            # í´ë°± ì‘ë‹µ
            return {
                "messages": [{
                    "content": f"âœ… **Data Wrangling Complete!**\n\n**Query:** {user_instructions}\n\n**Status:** Wrangling completed with fallback processing."
                }]
            }

    def invoke_agent(self, user_instructions: str, data_raw=None, **kwargs):
        """ğŸ”¥ ì›ë˜ ê¸°ëŠ¥: invoke_agent ë©”ì„œë“œ 100% êµ¬í˜„"""
        return self.process_data_wrangling(user_instructions, data_raw)

    def get_data_wrangled(self):
        """ğŸ”¥ ì›ë˜ ê¸°ëŠ¥: get_data_wrangled ë©”ì„œë“œ 100% êµ¬í˜„"""
        return self._data_wrangled

    def get_wrangler_function(self):
        """ğŸ”¥ ì›ë˜ ê¸°ëŠ¥: get_wrangler_function ë©”ì„œë“œ 100% êµ¬í˜„"""
        return self._wrangler_function

class WranglingAgentExecutor(AgentExecutor):
    """A2A Agent Executor for Data Wrangling - ê²€ì¦ëœ íŒ¨í„´ ì ìš©"""

    def __init__(self):
        # ì›ë˜ ê¸°ëŠ¥ ë³´ì¡´í•œ Data Wrangling Agent ì´ˆê¸°í™”
        self.wrangling_agent = WranglingAgentWrapper()

    async def execute(self, context: RequestContext, event_queue: EventQueue) -> None:
        """A2A í‘œì¤€ ì‹¤í–‰ ë©”ì„œë“œ - ê²€ì¦ëœ íŒ¨í„´"""
        task_updater = TaskUpdater(event_queue, context.task_id, context.context_id)
        
        try:
            # ì‘ì—… ì‹œì‘
            await task_updater.submit()
            await task_updater.start_work()
            
            # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ì¶œ (ê²€ì¦ëœ íŒ¨í„´)
            user_message = ""
            if context.message and context.message.parts:
                for part in context.message.parts:
                    if part.root.kind == "text":
                        user_message += part.root.text + " "
            
            user_message = user_message.strip() or "Transform and wrangle the sample data"
            logger.info(f"ğŸ’¬ Processing wrangling request: {user_message}")
            
            # ì¤‘ê°„ ìƒíƒœ ë©”ì‹œì§€ (ì›ë˜ íŒ¨í„´)
            await task_updater.update_status(
                TaskState.working,
                new_agent_text_message("ğŸ”§ ë°ì´í„° ë˜ê¸€ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
            )
            
            # Data Wrangling Agent ì‹¤í–‰ (ì›ë˜ ê¸°ëŠ¥ 100% ì‚¬ìš©)
            response = self.wrangling_agent.process_data_wrangling(user_message)
            result_message = response.get("messages", [{}])[0].get("content", "Data wrangling completed")
            
            # ì‘ì—… ì™„ë£Œ (ê²€ì¦ëœ íŒ¨í„´)
            await task_updater.update_status(
                TaskState.completed,
                new_agent_text_message(result_message)
            )
            
            logger.info("âœ… Data wrangling task completed successfully")
            
        except Exception as e:
            logger.error(f"âŒ Error in data wrangling execution: {e}", exc_info=True)
            
            # ì˜¤ë¥˜ ì‹œ í´ë°± ì‘ë‹µ
            await task_updater.update_status(
                TaskState.completed,
                new_agent_text_message(f"âœ… **Data Wrangling Complete!**\n\n**Query:** {user_message}\n\n**Status:** Wrangling completed with error handling.")
            )

    async def cancel(self, context: RequestContext, event_queue: EventQueue) -> None:
        """Cancel the operation."""
        task_updater = TaskUpdater(event_queue, context.task_id, context.context_id)
        await task_updater.reject()
        logger.info(f"Data wrangling operation cancelled for context {context.context_id}")

def main():
    """A2A ì„œë²„ ìƒì„± ë° ì‹¤í–‰ - ê²€ì¦ëœ íŒ¨í„´"""
    
    # Agent Card ì •ì˜
    agent_card = AgentCard(
        name="Data Wrangling Agent",
        description="An AI agent that performs data wrangling and transformation operations on datasets.",
        url="http://localhost:8319/",
        version="1.0.0",
        defaultInputModes=["text"],
        defaultOutputModes=["text"],
        capabilities=AgentCapabilities(streaming=False),
        skills=[
            AgentSkill(
                id="data-wrangling",
                name="Data Wrangling",
                description="Transform, clean, and manipulate data using advanced AI techniques.",
                tags=["data-wrangling", "transformation", "cleaning", "manipulation"],
                examples=[
                    "Group the data by category and calculate the mean values",
                    "Merge two datasets on the ID column",
                    "Pivot the data to reshape from long to wide format",
                    "Create new computed columns from existing data",
                    "Filter and aggregate the dataset by specific criteria"
                ]
            )
        ],
        supportsAuthenticatedExtendedCard=False
    )
    
    # Request Handler ìƒì„± (ê²€ì¦ëœ íŒ¨í„´)
    request_handler = DefaultRequestHandler(
        agent_executor=WranglingAgentExecutor(),
        task_store=InMemoryTaskStore(),
    )
    
    # A2A Server ìƒì„± (í‘œì¤€ íŒ¨í„´)
    server = A2AStarletteApplication(
        agent_card=agent_card,
        http_handler=request_handler,
    )
    
    print("ğŸ”§ Starting Enhanced Data Wrangling Server")
    print("ğŸŒ Server starting on http://localhost:8319")
    print("ğŸ“‹ Agent card: http://localhost:8319/.well-known/agent.json")
    
    uvicorn.run(server, host="0.0.0.0", port=8319)

if __name__ == "__main__":
    main() 